<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Gestión Documental Completa</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- jsPDF para informes -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- pdf-lib para unir PDFs -->
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">

  <!-- LOGIN -->
  <div id="loginScreen" class="max-w-sm mx-auto p-6 bg-white rounded-2xl shadow-lg">
    <!-- Texto grande PBIP APP en el login -->
    <div class="text-center mb-4">
      <div class="text-3xl font-extrabold text-gray-800">PBIP <span class="text-indigo-600">APP</span></div>
    </div>
    <h2 class="text-2xl font-bold text-center mb-4">Login</h2>
    <input id="username" placeholder="Usuario" class="w-full p-2 border rounded mb-2" />
    <input id="password" type="password" placeholder="Contraseña" class="w-full p-2 border rounded mb-4" />
    <button id="loginBtn" class="w-full bg-blue-600 text-white py-2 rounded">Ingresar</button>
    <p id="loginError" class="text-red-500 text-sm mt-2 hidden">Usuario o contraseña incorrectos</p>
  </div>

  <!-- MAIN APP -->
  <div id="app" class="hidden max-w-6xl mx-auto space-y-6">

    <!-- NAV -->
    <nav class="flex items-center w-full">
      <div class="flex items-center gap-3">
        <!-- Logo PBIP APP (simple, inline SVG) -->
        <div class="flex items-center gap-2">
          <svg viewBox="0 0 64 64" class="w-10 h-10 rounded p-1 bg-indigo-600" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <rect x="6" y="6" width="52" height="52" rx="8" fill="#ffffff" opacity="0.06"/>
            <rect x="10" y="10" width="44" height="44" rx="6" fill="#ffffff" opacity="0.08"/>
            <g transform="translate(16,18)" fill="#ffffff">
              <rect x="0" y="0" width="8" height="28" rx="2"/>
              <rect x="12" y="6" width="8" height="22" rx="2"/>
              <rect x="24" y="12" width="8" height="16" rx="2"/>
            </g>
          </svg>
          <div class="text-lg font-semibold text-gray-800">
            PBIP <span class="text-sm font-normal text-gray-600">APP</span>
          </div>
        </div>
      </div>
      <div class="flex gap-2 ml-6">
        <button id="navForm" type="button" class="px-4 py-2 bg-indigo-600 text-white rounded">Nuevo Ingreso</button>
        <button id="navWorkers" type="button" class="px-4 py-2 bg-gray-200 rounded">Listado Trabajadores</button>
        <button id="navCompanies" type="button" class="px-4 py-2 bg-gray-200 rounded">Listado Empresas</button>
        <button id="navReport" type="button" class="px-4 py-2 bg-gray-200 rounded">Reporte Ingresos</button>
        <button id="navVisitas" type="button" class="px-4 py-2 bg-gray-200 rounded">Visitas</button>
        <button id="navConsulta" type="button" class="px-4 py-2 bg-gray-200 rounded">Consulta de ingreso</button>
      </div>
      <button id="logoutBtn" class="ml-auto px-4 py-2 bg-red-500 text-white rounded">Cerrar sesión</button>
    </nav>

    <!-- FORM SCREEN -->
    <section id="formScreen" class="bg-white p-6 rounded shadow">
      <h3 class="text-xl font-bold mb-4">Ingreso Extraordinario</h3>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
          <label class="block mb-1">CUIT</label>
          <input id="cuit" class="w-full p-2 border rounded" />
        </div>
        <div>
          <label class="block mb-1">Empresa</label>
          <input id="empresa" class="w-full p-2 border rounded" />
        </div>
        <div>
          <label class="block mb-1">Apellido y Nombre</label>
          <input id="nombre" class="w-full p-2 border rounded" />
        </div>
        <div>
          <!-- espacio reservado para futuras columnas o controles -->
        </div>
      </div>

      <div class="mt-4">
        <label class="block mb-1">DNI</label>
        <input id="dni" class="w-full p-2 border rounded" />
      </div>

      <div class="mt-4">
        <label class="block mb-1">Tipo de trabajador</label>
        <select id="workerType" class="w-64 p-2 border rounded">
          <option value="">Seleccione...</option>
          <option value="monotributista">Monotributista</option>
          <option value="dependencia">Relación de Dependencia</option>
        </select>
      </div>

      <!-- Documents slots -->
      <div id="documentsSection" class="mt-4 space-y-3"></div>

      <!-- Acciones del formulario -->
      <div class="mt-4 flex gap-2">
        <button id="saveBtn" class="bg-green-600 text-white px-4 py-2 rounded">Guardar</button>
        <button id="clearFormBtn" class="bg-gray-300 px-4 py-2 rounded">Limpiar</button>
      </div>

    </section>

    <!-- WORKERS SCREEN -->
    <section id="workersScreen" class="hidden bg-white p-6 rounded shadow">
      <h3 class="text-xl font-bold mb-4">Listado de Trabajadores</h3>
      <div class="flex gap-2 mb-4">
        <input id="searchDNI" placeholder="Buscar por DNI" class="p-2 border rounded" />
        <input id="searchName" placeholder="Buscar por nombre" class="p-2 border rounded flex-1" />
        <button id="refreshWorkers" class="bg-blue-600 text-white px-3 py-1 rounded">Refrescar</button>
      </div>
      <div class="overflow-auto">
        <table class="w-full" id="workersTable">
          <!-- filas generadas por JS -->
        </table>
      </div>
    </section>

    <!-- COMPANIES SCREEN -->
    <section id="companiesScreen" class="hidden bg-white p-6 rounded shadow">
      <h3 class="text-xl font-bold mb-4">Listado de Empresas</h3>

     <div class="flex gap-2 mb-4">
       <input id="filterCompanyCUIT" placeholder="Filtrar por CUIT" class="p-2 border rounded" />
       <input id="filterCompanyName" placeholder="Buscar empresa" class="p-2 border rounded flex-1" />
       <button id="refreshCompanies" class="bg-blue-600 text-white px-3 py-1 rounded">Refrescar</button>
     </div>

      <div id="companiesList" class="space-y-2"></div>
    </section>

    <!-- WORKER DETAIL -->
    <section id="workerDetail" class="hidden bg-white p-6 rounded shadow">
      <h3 id="detailTitle" class="text-xl font-bold mb-2">Ficha</h3>
      <div id="detailBody" class="mt-4 space-y-3"></div>
      <div class="mt-4 flex gap-2">
        <button id="downloadReportBtn" class="bg-indigo-600 text-white px-4 py-2 rounded">Descargar Informe</button>
        <button id="downloadAllBtn" class="bg-purple-600 text-white px-4 py-2 rounded">Descargar Documentos Unidos</button>
        <button id="closeDetailBtn" class="bg-gray-300 px-4 py-2 rounded">Cerrar</button>
      </div>
    </section>

    <!-- REPORT SCREEN (agregado) -->
    <section id="reportScreen" class="hidden bg-white p-6 rounded shadow">
      <h3 class="text-xl font-bold mb-4">Reporte de Ingresos</h3>
      <div class="grid grid-cols-1 md:grid-cols-6 gap-3 mb-4 items-end">
        <div>
          <label class="block text-sm">Desde</label>
          <input id="reportStart" type="date" class="p-2 border rounded" />
        </div>
        <div>
          <label class="block text-sm">Hasta</label>
          <input id="reportEnd" type="date" class="p-2 border rounded" />
        </div>
        <div>
          <label class="block text-sm">Empresa</label>
          <input id="reportEmpresa" placeholder="Razón social" class="p-2 border rounded" />
        </div>
        <div>
          <label class="block text-sm">CUIT</label>
          <input id="reportCUIT" placeholder="CUIT" class="p-2 border rounded" />
        </div>
        <div>
          <label class="block text-sm">DNI</label>
          <input id="reportDNI" placeholder="DNI" class="p-2 border rounded" />
        </div>
        <div>
          <label class="block text-sm">Apellido / Nombre</label>
          <input id="reportName" placeholder="Apellido y/o nombre" class="p-2 border rounded" />
        </div>
      </div>
      <div class="flex gap-2 mb-4">
        <button id="reportRefresh" class="bg-blue-600 text-white px-3 py-1 rounded">Refrescar</button>
        <button id="exportPdfBtn" class="bg-indigo-600 text-white px-3 py-1 rounded">Exportar PDF</button>
        <button id="exportExcelBtn" class="bg-green-600 text-white px-3 py-1 rounded">Exportar Excel (CSV)</button>
      </div>
      <div class="overflow-auto">
        <table class="w-full" id="reportTable">
          <!-- filas generadas por JS -->
        </table>
      </div>
    </section>

    <!-- VISITS SCREEN -->
    <section id="visitsScreen" class="hidden bg-white p-6 rounded shadow">
      <h3 class="text-xl font-bold mb-4">Visitas</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
        <div>
          <label class="block mb-1">Apellido y Nombre</label>
          <input id="visitName" class="w-full p-2 border rounded" />
        </div>
        <div>
          <label class="block mb-1">DNI</label>
          <input id="visitDNI" class="w-full p-2 border rounded" />
        </div>
        <div>
          <label class="block mb-1">Tipo</label>
          <select id="visitType" class="w-full p-2 border rounded">
            <option value="">Seleccione...</option>
            <option value="particular">Particular</option>
            <option value="empresa">Empresa</option>
          </select>
        </div>
        <div id="companyWrapper" class="hidden">
          <label class="block mb-1">Razón social (empresa)</label>
          <input id="visitCompany" class="w-full p-2 border rounded" />
        </div>
        <div>
          <label class="block mb-1">Responsable de la visita</label>
          <input id="visitResponsible" class="w-full p-2 border rounded" />
        </div>
        <div class="md:col-span-3 text-right">
          <button id="addVisitBtn" class="bg-green-600 text-white px-4 py-2 rounded">Registrar visita</button>
        </div>
      </div>
    </section>

    <!-- after NAV (insert console) -->
    <div id="entryConsole" class="hidden max-w-6xl mx-auto mt-4 p-3 bg-white rounded shadow flex items-center gap-3">
      <label class="text-sm font-medium">Control ingreso (DNI):</label>
      <input id="checkDNIInput" placeholder="N° DNI" class="p-2 border rounded w-40" />
      <button id="checkDNIBtn" class="bg-blue-600 text-white px-3 py-1 rounded">Verificar</button>
      <div id="checkResult" class="ml-4 text-sm"></div>
      <button id="registerEntryBtn" class="ml-auto bg-green-600 text-white px-3 py-1 rounded hidden">Registrar ingreso</button>
    </div>

  </div>
  <script>
    // ---------- Helpers de almacenamiento ----------
    console.debug('script loaded');
    const STORAGE_KEY = "gd_records_v1"; // cambiar versión si actualizas estructura

    // Mensajes de runtime visibles en UI para debugging (temporal)
    // se crea aquí para que esté disponible incluso si hay errores tempranos
    try {
      const _rMsg = document.createElement('div');
      _rMsg.id = 'runtimeMsg';
      _rMsg.className = 'fixed top-4 right-4 p-3 bg-yellow-100 text-black rounded shadow hidden';
      document.body.appendChild(_rMsg);
    } catch (e) { console.warn('no pudo crear runtimeMsg', e); }

    window.addEventListener('error', (ev) => {
      try {
        console.error('Unhandled error', ev.error || ev.message || ev);
        const el = document.getElementById('runtimeMsg');
        if (el) { el.textContent = 'Error JS: ' + (ev.error?.message || ev.message || ev); safeRemove(el, 'hidden'); }
        alert('Error JS: ' + (ev.error?.message || ev.message || ev));
      } catch (e) { console.error(e); }
    });
    window.addEventListener('unhandledrejection', (ev) => {
      console.error('Unhandled promise rejection', ev.reason);
      const el = document.getElementById('runtimeMsg');
      if (el) { el.textContent = 'Unhandled promise rejection: ' + (ev.reason && ev.reason.message ? ev.reason.message : ev.reason); safeRemove(el, 'hidden'); }
    });
    function loadRecords() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
      } catch (e) {
        console.error(e);
        return [];
      }
    }
    function saveRecords(recs) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(recs));
    }

    // Convierte ArrayBuffer a base64
    function arrayBufferToBase64(buffer) {
      const bytes = new Uint8Array(buffer);
      let binary = "";
      const chunk = 0x8000;
      for (let i = 0; i < bytes.length; i += chunk) {
        binary += String.fromCharCode.apply(null, bytes.subarray(i, i + chunk));
      }
      return btoa(binary);
    }
    // Convierte base64 a Uint8Array
    function base64ToUint8Array(base64) {
      const binary = atob(base64);
      const len = binary.length;
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) bytes[i] = binary.charCodeAt(i);
      return bytes;
    }

    // utilidad: formato fecha y hora legible desde ISO (evita error fmtDateTime not defined)
    function fmtDateTime(iso) {
      if (!iso) return "";
      try { return new Date(iso).toLocaleString(); } catch (e) { return iso || ""; }
    }
    
    // ---------- Datos y documentos por defecto ----------
    const docsBase = [
      { key: "DNI", label: "DNI" },
      { key: "EPP", label: "Entrega de EPP" },
      { key: "MAIL_AGENCIA", label: "Mail aviso de la agencia" },
      { key: "CARNET_PREFECTURA", label: "Carnet de Prefectura" }
    ];
    const docsMono = [
      { key: "ARCA_INSCRIP", label: "Constancia de inscripción ante ARCA" },
      { key: "PAGO_MONOT", label: "Pago de Monotributo" },
      { key: "POLIZA_ACC", label: "Póliza de Accidentes Personales" },
      { key: "LIBRE_DEUDA_POL", label: "Libre deuda Póliza de Acc. Personales" }
    ];
    const docsDep = [
      { key: "ALTA_ARCA", label: "Alta temprana ante ARCA" },
      { key: "CONST_ART", label: "Constancia de Aseguramiento ante la ART" }
    ];

    // ---------- Estado en memoria ----------
    let records = loadRecords(); // array de {empresa,nombre,dni,tipo, documents: [ {key,label,fileName,base64,expiry}]}
    let selectedWorkerIndex = null;

    // ---------- Elementos DOM ----------
    const loginScreen = document.getElementById("loginScreen");
    const app = document.getElementById("app");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const loginError = document.getElementById("loginError");

    // Helpers seguros para manipular classList cuando el elemento puede ser null
    function safeAdd(el, cls) { try { if (el && el.classList) el.classList.add(cls); } catch(e){} }
    function safeRemove(el, cls) { try { if (el && el.classList) el.classList.remove(cls); } catch(e){} }

    const navForm = document.getElementById("navForm");
    const navWorkers = document.getElementById("navWorkers");
    const navCompanies = document.getElementById("navCompanies");
    const navReport = document.getElementById("navReport");
    const navVisitas = document.getElementById("navVisitas");
    const navConsulta = document.getElementById("navConsulta");
    const entryConsole = document.getElementById("entryConsole");
    const visitsScreen = document.getElementById("visitsScreen");
    const visitName = document.getElementById("visitName");
    const visitDNI = document.getElementById("visitDNI");
    const visitType = document.getElementById("visitType");
    const visitCompany = document.getElementById("visitCompany");
    const companyWrapper = document.getElementById("companyWrapper");
    const visitResponsible = document.getElementById("visitResponsible");
    const addVisitBtn = document.getElementById("addVisitBtn");

    const formScreen = document.getElementById("formScreen");
    const cuitInput = document.getElementById("cuit");
    const empresaInput = document.getElementById("empresa");
    const nombreInput = document.getElementById("nombre");
    const dniInput = document.getElementById("dni");
    const workerTypeSelect = document.getElementById("workerType");
    const documentsSection = document.getElementById("documentsSection");
    const saveBtn = document.getElementById("saveBtn");
    const clearFormBtn = document.getElementById("clearFormBtn");

    const workersScreen = document.getElementById("workersScreen");
    const workersTable = document.getElementById("workersTable");
    const searchDNI = document.getElementById("searchDNI");
    const searchName = document.getElementById("searchName");
    const refreshWorkers = document.getElementById("refreshWorkers");

    const companiesScreen = document.getElementById("companiesScreen");
    const companiesList = document.getElementById("companiesList");

    const workerDetail = document.getElementById("workerDetail");
    const detailBody = document.getElementById("detailBody");
    const detailTitle = document.getElementById("detailTitle");
    const downloadReportBtn = document.getElementById("downloadReportBtn");
    const downloadAllBtn = document.getElementById("downloadAllBtn");
    const closeDetailBtn = document.getElementById("closeDetailBtn");

    const reportScreen = document.getElementById("reportScreen");
    const reportStart = document.getElementById("reportStart");
    const reportEnd = document.getElementById("reportEnd");
    const reportEmpresa = document.getElementById("reportEmpresa");
    const reportCUIT = document.getElementById("reportCUIT");
    const reportDNI = document.getElementById("reportDNI");
    const reportName = document.getElementById("reportName");
    const reportRefresh = document.getElementById("reportRefresh");
    const exportPdfBtn = document.getElementById("exportPdfBtn");
    const exportExcelBtn = document.getElementById("exportExcelBtn");
    const reportTable = document.getElementById("reportTable");

    // ---------- Login ----------
    loginBtn.addEventListener("click", () => {
      const u = document.getElementById("username").value.trim();
      const p = document.getElementById("password").value.trim();
      // modo debug: aceptar cualquier credencial no vacía para facilitar pruebas
      if ((u === "1" && p === "1") || (u && p)) {
        safeAdd(loginScreen, "hidden");
        safeRemove(app, "hidden");
        showForm();
      } else {
        safeRemove(loginError, "hidden");
      }
    });
    logoutBtn.addEventListener("click", () => {
      // refrescar sesión a login (sin limpiar datos)
      safeAdd(app, "hidden");
      safeRemove(loginScreen, "hidden");
      document.getElementById("username").value = "";
      document.getElementById("password").value = "";
    });

    // ---------- Navegación ----------
    if (navForm) navForm.addEventListener("click", (ev) => { showForm(); });
    if (navWorkers) navWorkers.addEventListener("click", (ev) => { showWorkers(); });
    if (navCompanies) navCompanies.addEventListener("click", (ev) => { showCompanies(); });
    if (navReport) navReport.addEventListener("click", () => showReport());
    if (navConsulta) navConsulta.addEventListener("click", () => { hideAllScreens(); safeRemove(entryConsole, "hidden"); });
    if (navVisitas) navVisitas.addEventListener("click", () => { hideAllScreens(); safeRemove(visitsScreen, "hidden"); });

    function hideAllScreens() {
      safeAdd(formScreen, "hidden");
      safeAdd(workersScreen, "hidden");
      safeAdd(companiesScreen, "hidden");
      safeAdd(workerDetail, "hidden");
      safeAdd(reportScreen, "hidden");
      // ocultar panel de consulta también
      safeAdd(entryConsole, "hidden");
     // ocultar visitas
     safeAdd(visitsScreen, "hidden");
    }

    // ---------- Renderizar slots de documentos según tipo ----------
    function renderDocumentSlots() {
      documentsSection.innerHTML = "";
      let list = [...docsBase];
      const tipo = workerTypeSelect.value;
      if (tipo === "monotributista") list.push(...docsMono);
      if (tipo === "dependencia") list.push(...docsDep);

      list.forEach(doc => {
        const div = document.createElement("div");
        div.className = "p-3 border rounded flex flex-col md:flex-row md:items-center md:justify-between gap-2";
        // si es el Mail de la agencia ahora renderizamos un uploader de PDF (sin campo de vencimiento)
        if (doc.key === "MAIL_AGENCIA") {
          div.innerHTML = `
            <div class="flex-1">
              <div class="font-semibold">${doc.label}</div>
              <div class="text-xs text-gray-600">Subir PDF (sin fecha de vencimiento)</div>
            </div>
            <div class="flex items-center gap-2">
              <input type="file" accept="application/pdf" data-doc-key="${doc.key}" class="doc-file hidden" />
              <button class="uploadBtn px-3 py-1 bg-blue-600 text-white rounded">Elegir PDF</button>
              <div class="status ml-3 text-sm"></div>
            </div>
          `;
        } else {
           div.innerHTML = `
             <div class="flex-1">
               <div class="font-semibold">${doc.label}</div>
               <div class="text-xs text-gray-600">Subir PDF y seleccionar fecha de vencimiento (opcional)</div>
             </div>
             <div class="flex items-center gap-2">
               <input type="file" accept="application/pdf" data-doc-key="${doc.key}" class="doc-file hidden" />
               <button class="uploadBtn px-3 py-1 bg-blue-600 text-white rounded">Elegir PDF</button>
               <input type="date" class="vencimiento p-1 border rounded" />
               <div class="status ml-3 text-sm"></div>
             </div>
           `;
         }
        documentsSection.appendChild(div);

        const fileInput = div.querySelector(".doc-file");
        const uploadBtn = div.querySelector(".uploadBtn");
        const vencInput = div.querySelector(".vencimiento");
        const status = div.querySelector(".status");

        if (uploadBtn && fileInput) {
          uploadBtn.addEventListener("click", () => fileInput.click());
          fileInput.addEventListener("change", async (ev) => {
            const f = ev.target.files[0];
            if (!f) return;
            if (f.type !== "application/pdf") {
              alert("Solo se permiten archivos PDF");
              fileInput.value = "";
              return;
            }
            const ab = await f.arrayBuffer();
            const base64 = arrayBufferToBase64(ab);
            // marcar temporalmente en el UI (se guardará en guardar registro)
            uploadBtn.textContent = f.name;
            uploadBtn.title = f.name;
            uploadBtn.dataset.fileName = f.name;
            uploadBtn.dataset.base64 = base64;
            uploadBtn.dataset.key = doc.key;
          });
        }
        // control de vencimiento visual (solo para los que tienen vencimiento input)
        if (vencInput) {
          vencInput.addEventListener("change", () => {
            const today = new Date().toISOString().split("T")[0];
            if (!vencInput.value) {
              status.textContent = "";
              status.className = "status ml-3 text-sm";
              return;
            }
            if (vencInput.value < today) {
              status.textContent = "Vencido";
              status.className = "status ml-3 text-sm text-red-600 font-semibold";
            } else {
              status.textContent = "Vigente";
              status.className = "status ml-3 text-sm text-green-600 font-semibold";
            }
          });
        }
      });
    }

    workerTypeSelect.addEventListener("change", renderDocumentSlots);

    // ---------- Guardar trabajador ----------
    saveBtn.addEventListener("click", () => {
       const cuit = cuitInput ? cuitInput.value.trim() : "";
       const empresa = empresaInput.value.trim();
       const nombre = nombreInput.value.trim();
       const dni = dniInput.value.trim();
       const tipo = workerTypeSelect.value;
 
       if (!empresa || !nombre || !dni || !tipo) {
         alert("Complete todos los campos obligatorios");
         return;
       }

      // Verificar duplicado por DNI
      const existingIndex = records.findIndex(r => r.dni === dni);
      if (existingIndex !== -1) {
        if (!confirm("Ya existe un trabajador con ese DNI. ¿Desea actualizarlo?")) return;
      }

      // Recolectar documentos cargados en UI (incluye MAIL_AGENCIA como PDF sin vencimiento)
      const docDivs = documentsSection.querySelectorAll("div");
      const documents = [];
      docDivs.forEach(div => {
        const uploadBtn = div.querySelector(".uploadBtn");
        const vencInput = div.querySelector(".vencimiento");
        const labelEl = div.querySelector(".font-semibold");
        const label = labelEl ? labelEl.textContent : 'Documento';
        const hasFile = !!(uploadBtn && uploadBtn.dataset && uploadBtn.dataset.base64);
        if (hasFile) {
          documents.push({
            key: (uploadBtn.dataset && uploadBtn.dataset.key) || "",
            label,
            fileName: (uploadBtn.dataset && uploadBtn.dataset.fileName) || "archivo.pdf",
            base64: uploadBtn.dataset.base64,
            expiry: vencInput ? (vencInput.value || null) : null
          });
        } else if (vencInput && vencInput.value) {
          // guardar slot con fecha aunque no tenga archivo
          const key = (uploadBtn && uploadBtn.dataset && uploadBtn.dataset.key) || "";
          documents.push({
            key,
            label,
            fileName: null,
            base64: null,
            expiry: vencInput.value
          });
        }
      });

      const record = { cuit, empresa, nombre, dni, tipo, documents, createdAt: new Date().toISOString() };
 
      if (existingIndex !== -1) {
        records[existingIndex] = record;
        alert("Registro actualizado");
      } else {
        records.push(record);
        alert("Registro guardado");
      }
      saveRecords(records);
      clearForm();
      renderWorkersTable();
    });

    clearFormBtn.addEventListener("click", clearForm);

    function clearForm() {
      if (cuitInput) cuitInput.value = "";
      empresaInput.value = "";
      nombreInput.value = "";
      dniInput.value = "";
      workerTypeSelect.value = "";
      documentsSection.innerHTML = "";
    }

    // ---------- Listado de trabajadores ----------
    function showWorkers() {
      hideAllScreens();
      renderWorkersTable();
      workersScreen.classList.remove("hidden");
    }

    function renderWorkersTable() {
      workersTable.innerHTML = "";
      const dniQ = searchDNI.value.trim();
      const nameQ = searchName.value.trim().toLowerCase();

      records.forEach((r, i) => {
        if (dniQ && !r.dni.includes(dniQ)) return;
        if (nameQ && !r.nombre.toLowerCase().includes(nameQ)) return;

        const tr = document.createElement("tr");
        tr.className = "border-b";
        const docsHtml = r.documents && r.documents.length ? r.documents.map(d => {
          // color by expiry if exists
          let status = "";
          if (d.expiry) {
            const today = new Date().toISOString().split("T")[0];
            status = d.expiry < today ? `<span class="text-red-600 font-semibold">Vencido</span>` : `<span class="text-green-600 font-semibold">Vigente</span>`;
          }
          return `<div class="text-xs">${d.label} ${d.fileName ? `- ${d.fileName}` : ''} ${status}</div>`;
        }).join("") : "<div class='text-xs text-gray-500'>Sin documentos</div>";

        tr.innerHTML = `
          <td class="p-2">${r.dni}</td>
          <td class="p-2">${r.nombre}</td>
          <td class="p-2">${r.empresa}</td>
          <td class="p-2">${r.tipo}</td>
          <td class="p-2">${docsHtml}</td>
          <td class="p-2">
            <button class="viewBtn bg-blue-600 text-white px-2 py-1 rounded">Ver</button>
            <button class="delBtn bg-red-500 text-white px-2 py-1 rounded ml-1">Eliminar</button>
          </td>
        `;
        workersTable.appendChild(tr);

        tr.querySelector(".viewBtn").addEventListener("click", () => openWorkerDetail(i));
        tr.querySelector(".delBtn").addEventListener("click", () => {
          if (confirm("Eliminar registro?")) {
            records.splice(i, 1);
            saveRecords(records);
            renderWorkersTable();
          }
        });
      });
    }

    refreshWorkers.addEventListener("click", renderWorkersTable);
    searchDNI.addEventListener("input", renderWorkersTable);
    searchName.addEventListener("input", renderWorkersTable);

    // ---------- Companies ----------
    function showCompanies() {
      hideAllScreens();
      companiesScreen.classList.remove("hidden");
      renderCompanies();
    }
    function renderCompanies() {
      // Agrupar por empresa
      const map = {};
      records.forEach(r => {
        if (!map[r.empresa]) map[r.empresa] = [];
        map[r.empresa].push(r);
      });
      companiesList.innerHTML = "";
      Object.keys(map).forEach(emp => {
        const div = document.createElement("div");
        div.className = "p-3 border rounded flex justify-between items-center";
        div.innerHTML = `<div><div class="font-semibold">${emp}</div><div class="text-sm text-gray-600">${map[emp].length} trabajadores</div></div>
                         <div><button class="viewCompanyBtn bg-blue-600 text-white px-3 py-1 rounded">Ver trabajadores</button></div>`;
        companiesList.appendChild(div);
        div.querySelector(".viewCompanyBtn").addEventListener("click", () => {
          // filtrar listado de trabajadores por empresa
          searchDNI.value = "";
          searchName.value = "";
          renderWorkersTable();
          // mostrar solo los de la empresa
          workersTable.querySelectorAll("tr").forEach(tr => tr.remove());
          map[emp].forEach((r, i) => {
            const tr = document.createElement("tr");
            tr.className = "border-b";
            tr.innerHTML = `<td class="p-2">${r.dni}</td><td class="p-2">${r.nombre}</td><td class="p-2">${r.empresa}</td><td class="p-2">${r.tipo}</td><td class="p-2"></td><td class="p-2"><button class="viewBtn bg-blue-600 text-white px-2 py-1 rounded">Ver</button></td>`;
            workersTable.appendChild(tr);
            tr.querySelector(".viewBtn").addEventListener("click", () => {
              // encontrar índice real y abrir
              const idx = records.findIndex(rr => rr.dni === r.dni);
              if (idx !== -1) openWorkerDetail(idx);
            });
          });
          hideAllScreens();
          workersScreen.classList.remove("hidden");
        });
      });
    }

    // ---------- Autocompletar por DNI en formulario ----------
    dniInput.addEventListener("blur", () => {
      const v = dniInput.value.trim();
      if (!v) return;
      const found = records.find(r => r.dni === v);
      if (found) {
        if (confirm("Trabajador existente — ¿cargar datos al formulario?")) {
          if (cuitInput) cuitInput.value = found.cuit || "";
          empresaInput.value = found.empresa;
          nombreInput.value = found.nombre;
          workerTypeSelect.value = found.tipo;
          renderDocumentSlots();
          // rellenar los slots con info de documentos si existen
          setTimeout(() => { // esperar que slots se creen
            const divs = documentsSection.querySelectorAll("div");
            divs.forEach(div => {
              const label = div.querySelector(".font-semibold").textContent;
              const uploadBtn = div.querySelector(".uploadBtn");
              const vencInput = div.querySelector(".vencimiento");
              const doc = (found.documents || []).find(d => d.label === label);
              if (doc) {
                if (uploadBtn) {
                  if (doc.fileName) uploadBtn.textContent = doc.fileName;
                  if (doc.base64) uploadBtn.dataset.base64 = doc.base64;
                }
                if (vencInput) vencInput.value = doc.expiry || "";
                // marcar estado
                const today = new Date().toISOString().split("T")[0];
                const status = div.querySelector(".status");
                if (doc.expiry && status) {
                  if (doc.expiry < today) {
                    status.textContent = "Vencido";
                    status.className = "status ml-3 text-sm text-red-600 font-semibold";
                  } else {
                    status.textContent = "Vigente";
                    status.className = "status ml-3 text-sm text-green-600 font-semibold";
                  }
                }
              }
            });
           }, 50);
        }
      }
    });

    // ---------- Ficha del trabajador ----------
    function openWorkerDetail(index) {
      selectedWorkerIndex = index;
      const r = records[index];
      hideAllScreens();
      workerDetail.classList.remove("hidden");
      detailTitle.textContent = `Ficha: ${r.nombre} — ${r.dni}`;
      renderDetailBody(r);
    }

    function renderDetailBody(r) {
      detailBody.innerHTML = "";
      const info = document.createElement("div");
      info.innerHTML = `
    <div><b>Nombre:</b> ${r.nombre}</div>
    <div><b>DNI:</b> ${r.dni}</div>
    <div><b>CUIT:</b> ${r.cuit ? r.cuit : '—'}</div>
    <div><b>Empresa:</b> ${r.empresa}</div>
        <div><b>Tipo:</b> ${r.tipo}</div>
        <div><b>Fecha de alta:</b> ${new Date(r.createdAt).toLocaleString()}</div>
        <hr class="my-2" />
      `;
      detailBody.appendChild(info);

      const docsDiv = document.createElement("div");
      docsDiv.innerHTML = `<div class="font-semibold mb-2">Documentos</div>`;
      (r.documents || []).forEach((d, i) => {
        const row = document.createElement("div");
        row.className = "p-2 border rounded mb-2 flex items-center justify-between gap-2";
        const left = document.createElement("div");
        left.innerHTML = `<div class="font-semibold">${d.label}</div>
                          ${d.value ? `<div class="text-xs text-gray-600">Correo: ${d.value}</div>` : `<div class="text-xs text-gray-600">${d.fileName ? d.fileName : '(sin archivo)'}</div>`}
                          <div class="text-xs">Vencimiento: ${d.expiry ? d.expiry : '—'}</div>`;
        const right = document.createElement("div");
        const downloadBtn = document.createElement("button");
        downloadBtn.className = "px-3 py-1 bg-blue-600 text-white rounded text-sm";
        downloadBtn.textContent = "Descargar";
        downloadBtn.disabled = !d.base64;
        downloadBtn.addEventListener("click", () => {
          if (!d.base64) return alert("No hay archivo para descargar.");
          downloadBase64AsFile(d.base64, d.fileName || (d.label + ".pdf"));
        });
        // vencimiento color
        const today = new Date().toISOString().split("T")[0];
        const statusSpan = document.createElement("div");
        if (d.expiry) {
          statusSpan.innerHTML = d.expiry < today ? `<span class="text-red-600 font-semibold">Vencido</span>` : `<span class="text-green-600 font-semibold">Vigente</span>`;
        } else {
          statusSpan.innerHTML = `<span class="text-gray-600">—</span>`;
        }
        right.appendChild(downloadBtn);
        right.appendChild(statusSpan);
        row.appendChild(left);
        row.appendChild(right);
        docsDiv.appendChild(row);
      });
      detailBody.appendChild(docsDiv);
    }

    closeDetailBtn.addEventListener("click", () => {
      workerDetail.classList.add("hidden");
      showWorkers();
    });

    // ---------- Descargar informe PDF (jsPDF) ----------
    downloadReportBtn.addEventListener("click", async () => {
      if (selectedWorkerIndex === null) return;
      const r = records[selectedWorkerIndex];
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 20;
      doc.setFontSize(16);
      doc.text("Informe de Ingreso", 14, y);
      y += 10;
      doc.setFontSize(12);
      doc.text(`Nombre: ${r.nombre}`, 14, y); y += 7;
      doc.text(`DNI: ${r.dni}`, 14, y); y += 7;
      doc.text(`Empresa: ${r.empresa}`, 14, y); y += 7;
      doc.text(`Tipo: ${r.tipo}`, 14, y); y += 10;
      doc.text("Documentos:", 14, y); y += 7;
      (r.documents || []).forEach(d => {
        const status = d.expiry ? (d.expiry < new Date().toISOString().split("T")[0] ? " (VENCIDO)" : " (VIGENTE)") : "";
        const fileInfo = d.fileName ? ` - ${d.fileName}` : "";
        const line = `${d.label}${fileInfo}${d.expiry ? " - Vto: " + d.expiry : ""}${status}`;
        const lines = doc.splitTextToSize(line, 180);
        doc.text(lines, 14, y);
        y += (lines.length * 6);
        if (y > 270) { doc.addPage(); y = 20; }
      });
      doc.save(`informe_${r.dni}.pdf`);
    });

    // ---------- Unir todos los PDFs y descargar (pdf-lib) ----------
    downloadAllBtn.addEventListener("click", async () => {
      if (selectedWorkerIndex === null) return;
      const r = records[selectedWorkerIndex];
      const pdfsToMerge = (r.documents || []).filter(d => d.base64);
      if (!pdfsToMerge.length) return alert("No hay PDFs cargados para unir.");

      try {
        const mergedPdf = await PDFLib.PDFDocument.create();
        for (const pd of pdfsToMerge) {
          // cada pd.base64 es base64 sin header
          const uint8 = base64ToUint8Array(pd.base64);
          const donorPdf = await PDFLib.PDFDocument.load(uint8);
          const copiedPages = await mergedPdf.copyPages(donorPdf, donorPdf.getPageIndices());
          copiedPages.forEach(p => mergedPdf.addPage(p));
        }
        const mergedBytes = await mergedPdf.save();
        // descargar
        const blob = new Blob([mergedBytes], { type: "application/pdf" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `documentos_unidos_${r.dni}.pdf`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (e) {
        console.error(e);
        alert("Error uniendo PDFs: " + (e.message || e));
      }
    });

    // ---------- Descargar base64 como archivo ----------
    function downloadBase64AsFile(base64, filename) {
      const uint8 = base64ToUint8Array(base64);
      const blob = new Blob([uint8], { type: "application/pdf" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // ---------- Inicialización ----------
    function showForm() {
      hideAllScreens();
      formScreen.classList.remove("hidden");
      renderDocumentSlots();
    }

    // Mostrar lista al inicio si hay registros
    function init() {
      renderDocumentSlots();
      renderWorkersTable();
      // si el usuario abre reporte desde inicio, actualizar filtros
      try { if (typeof renderReportTable === 'function') renderReportTable(); } catch(e){}
    }
    init();

    // ---------- Report vars (nuevos elementos DOM) ----------
    // conectar navReport si existe
    if (navReport) navReport.addEventListener("click", () => showReport());

    function showReport() {
      hideAllScreens();
      if (reportScreen) reportScreen.classList.remove("hidden");
      renderReportTable();
    }

    // ---------- Render y filtros para reporte ----------
    function renderReportTable() {
      if (!reportTable) return;
      reportTable.innerHTML = "";
      const start = reportStart && reportStart.value ? reportStart.value : null;
      const end = reportEnd && reportEnd.value ? reportEnd.value : null;
      const empresaQ = (reportEmpresa && reportEmpresa.value || "").trim().toLowerCase();
      const cuitQ = (reportCUIT && reportCUIT.value || "").trim();
      const dniQ = (reportDNI && reportDNI.value || "").trim();
      const nameQ = (reportName && reportName.value || "").trim().toLowerCase();

      // header: Ingreso / Egreso / CUIT / DNI / Nombre / Empresa / Tipo / #Docs / Acciones
      const thead = document.createElement("tr");
      thead.className = "font-semibold border-b";
      thead.innerHTML = `<td class="p-2">Ingreso</td><td class="p-2">Egreso</td><td class="p-2">CUIT</td><td class="p-2">DNI</td><td class="p-2">Nombre</td><td class="p-2">Empresa</td><td class="p-2">Tipo</td><td class="p-2"># Docs</td><td class="p-2">Acciones</td>`;
      reportTable.appendChild(thead);

      const rows = [];
      records.forEach((r, i) => {
        const created = r.createdAt ? r.createdAt.split("T")[0] : null;
        if (start && created && created < start) return;
        if (end && created && created > end) return;
        if (empresaQ && (!r.empresa || !r.empresa.toLowerCase().includes(empresaQ))) return;
        if (cuitQ && (!r.cuit || !String(r.cuit).includes(cuitQ))) return;
        if (dniQ && (!r.dni || !String(r.dni).includes(dniQ))) return;
        if (nameQ && (!r.nombre || !r.nombre.toLowerCase().includes(nameQ))) return;
        rows.push({ r, idx: i });
      });

      rows.forEach(item => {
        const r = item.r;
        const idx = item.idx;
        const tr = document.createElement("tr");
        tr.className = "border-b";
        const ingreso = fmtDateTime(r.createdAt);
        const egreso = r.exitAt ? fmtDateTime(r.exitAt) : "";
        const docsCount = (r.documents || []).length;
        const actionHtml = r.exitAt ? "" : `<button class="registerExitBtn bg-yellow-500 text-white px-2 py-1 rounded text-sm" data-idx="${idx}">Registrar Salida</button>`;
        tr.innerHTML = `<td class="p-2">${ingreso}</td>
                        <td class="p-2">${egreso}</td>
                        <td class="p-2">${r.cuit || ''}</td>
                        <td class="p-2">${r.dni}</td>
                        <td class="p-2">${r.nombre}</td>
                        <td class="p-2">${r.empresa}</td>
                        <td class="p-2">${r.tipo}</td>
                        <td class="p-2">${docsCount}</td>
                        <td class="p-2">${actionHtml}</td>`;
        reportTable.appendChild(tr);
        const btn = tr.querySelector('.registerExitBtn');
        if (btn) {
          btn.addEventListener('click', () => {
            if (!confirm('Registrar salida y guardar hora de egreso?')) return;
            records[idx].exitAt = new Date().toISOString();
            saveRecords(records);
            renderReportTable();
            renderWorkersTable();
          });
        }
      });
    }
 
    // Export CSV (Excel)
    function exportReportCSV() {
      const start = reportStart && reportStart.value ? reportStart.value : null;
      const end = reportEnd && reportEnd.value ? reportEnd.value : null;
      const empresaQ = (reportEmpresa && reportEmpresa.value || "").trim().toLowerCase();
      const cuitQ = (reportCUIT && reportCUIT.value || "").trim();
      const dniQ = (reportDNI && reportDNI.value || "").trim();
      const nameQ = (reportName && reportName.value || "").trim().toLowerCase();

      const filtered = records.filter(r => {
        const created = r.createdAt ? r.createdAt.split("T")[0] : null;
        if (start && created && created < start) return false;
        if (end && created && created > end) return false;
        if (empresaQ && (!r.empresa || !r.empresa.toLowerCase().includes(empresaQ))) return false;
        if (cuitQ && (!r.cuit || !String(r.cuit).includes(cuitQ))) return false;
        if (dniQ && (!r.dni || !String(r.dni).includes(dniQ))) return false;
        if (nameQ && (!r.nombre || !r.nombre.toLowerCase().includes(nameQ))) return false;
        return true;
      });
      if (!filtered.length) return alert("No hay registros para exportar.");
      const lines = [["Ingreso","Egreso","CUIT","DNI","Nombre","Empresa","Tipo","#Docs"]];
      filtered.forEach(r => lines.push([fmtDateTime(r.createdAt), r.exitAt ? fmtDateTime(r.exitAt) : "", r.cuit||"", r.dni||"", r.nombre||"", r.empresa||"", r.tipo||"", (r.documents||[]).length]));
      const csv = lines.map(l => l.map(v => `"${String(v).replace(/"/g,'""')}"`).join(",")).join("\r\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `reporte_ingresos_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }
 
    // Export PDF (simple table using jsPDF)
    function exportReportPDF() {
      const start = reportStart && reportStart.value ? reportStart.value : null;
      const end = reportEnd && reportEnd.value ? reportEnd.value : null;
      const empresaQ = (reportEmpresa && reportEmpresa.value || "").trim().toLowerCase();
      const cuitQ = (reportCUIT && reportCUIT.value || "").trim();
      const dniQ = (reportDNI && reportDNI.value || "").trim();
      const nameQ = (reportName && reportName.value || "").trim().toLowerCase();

      const filtered = records.filter(r => {
        const created = r.createdAt ? r.createdAt.split("T")[0] : null;
        if (start && created && created < start) return false;
        if (end && created && created > end) return false;
        if (empresaQ && (!r.empresa || !r.empresa.toLowerCase().includes(empresaQ))) return false;
        if (cuitQ && (!r.cuit || !String(r.cuit).includes(cuitQ))) return false;
        if (dniQ && (!r.dni || !String(r.dni).includes(dniQ))) return false;
        if (nameQ && (!r.nombre || !r.nombre.toLowerCase().includes(nameQ))) return false;
        return true;
      });
      if (!filtered.length) return alert("No hay registros para exportar.");
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('l', 'pt', 'a4');
      const margin = 40;
      let y = 40;
      doc.setFontSize(14);
      doc.text("Reporte de Ingresos", margin, y);
      y += 20;
      doc.setFontSize(10);
      const header = ["Ingreso","Egreso","CUIT","DNI","Nombre","Empresa","Tipo","#Docs"];
      // pintar header
      let x = margin;
      const colW = [(100),(100),(80),(70),(180),(140),(100),(50)];
      header.forEach((h, i) => { doc.text(String(h), x, y); x += colW[i]; });
      y += 14;
      // filas
      filtered.forEach(r => {
        x = margin;
        const row = [fmtDateTime(r.createdAt), r.exitAt ? fmtDateTime(r.exitAt) : "", r.cuit||"", r.dni||"", r.nombre||"", r.empresa||"", r.tipo||"", String((r.documents||[]).length)];
        row.forEach((cell, i) => {
          const lines = doc.splitTextToSize(String(cell), colW[i]-6);
          doc.text(lines, x, y);
          x += colW[i];
        });
        y += 14;
        if (y > 520) { doc.addPage(); y = 40; }
      });
      doc.save(`reporte_ingresos_${new Date().toISOString().slice(0,10)}.pdf`);
    }

    // ---------- Nuevo: Console de verificación por DNI ----------
    const checkDNIInput = document.getElementById('checkDNIInput');
    const checkDNIBtn = document.getElementById('checkDNIBtn');
    const checkResult = document.getElementById('checkResult');
    const registerEntryBtn = document.getElementById('registerEntryBtn');

    function formatList(items) { return items.map(i => `<div>- ${i}</div>`).join(''); }

    // Determina lista de documentos requeridos según tipo
    function requiredDocsForTipo(tipo) {
      let list = [...docsBase];
      if (tipo === 'monotributista') list.push(...docsMono);
      if (tipo === 'dependencia') list.push(...docsDep);
      return list;
    }

    // Verifica si el trabajador está apto: devuelve { ok: bool, missing: [], expired: [], msg }
    function verifyWorkerForEntry(worker) {
      const today = new Date().toISOString().split('T')[0];
      const required = requiredDocsForTipo(worker.tipo);
      const missing = [];
      const expired = [];

      required.forEach(req => {
        // buscar por key preferentemente, fallback por label
        const found = (worker.documents || []).find(d => (d.key && d.key === req.key) || (d.label && d.label === req.label));
        if (!found) {
          missing.push(req.label);
          return;
        }
        // exigir archivo o al menos fileName
        const hasFile = !!(found.base64 || found.fileName);
        if (!hasFile) { missing.push(req.label); return; }
        // si tiene expiry, verificar vigencia; si no tiene expiry, considerar como faltante (según regla "con fecha en vigencia")
        if (!found.expiry) { missing.push(req.label + " (sin fecha)"); return; }
        if (found.expiry < today) { expired.push(`${req.label} (vto ${found.expiry})`); }
      });
      const ok = (missing.length === 0 && expired.length === 0);
      const msg = ok ? 'APROBADO: puede ingresar' : 'RECHAZADO: revisar documentación';
      return { ok, missing, expired, msg };
    }

    let lastCheckedWorker = null;

    if (checkDNIBtn) checkDNIBtn.addEventListener('click', () => {
      const dni = (checkDNIInput && checkDNIInput.value || '').trim();
      checkResult.innerHTML = '';
      if (!dni) { checkResult.innerHTML = `<span class="text-red-600">Ingrese un DNI</span>`; registerEntryBtn.classList.add('hidden'); return; }
      // buscar el último registro del trabajador (por DNI) - tomar el más reciente
      const foundIndex = records.map((r, i) => ({r,i})).filter(x => x.r.dni === dni).sort((a,b) => (b.r.createdAt||'').localeCompare(a.r.createdAt||''))[0];
      if (!foundIndex) {
        checkResult.innerHTML = `<span class="text-red-600">No existe trabajador con DNI ${dni}</span>`;
        registerEntryBtn.classList.add('hidden');
        lastCheckedWorker = null;
        return;
      }
      const worker = foundIndex.r;
      lastCheckedWorker = worker;
      const res = verifyWorkerForEntry(worker);
      if (res.ok) {
        checkResult.innerHTML = `<span class="text-green-600 font-semibold">${res.msg}</span>`;
        registerEntryBtn.classList.remove('hidden');
      } else {
        let html = `<div class="text-red-600 font-semibold">${res.msg}</div>`;
        if (res.missing.length) html += `<div class="mt-1 text-sm">Faltantes:${formatList(res.missing)}</div>`;
        if (res.expired.length) html += `<div class="mt-1 text-sm">Vencidos:${formatList(res.expired)}</div>`;
        checkResult.innerHTML = html;
        registerEntryBtn.classList.add('hidden');
      }
    });

    // Registrar ingreso: crea una nueva entrada (copia) con createdAt = ahora y la añade a records + actualiza reportes
    if (registerEntryBtn) registerEntryBtn.addEventListener('click', () => {
      if (!lastCheckedWorker) return alert('No hay trabajador verificado.');
      const now = new Date().toISOString();
      // incluir exitAt para poder registrar la salida posteriormente
      const newRecord = Object.assign({}, lastCheckedWorker, { createdAt: now, exitAt: null });
      records.push(newRecord);
      saveRecords(records);
      renderReportTable && renderReportTable();
      renderWorkersTable && renderWorkersTable();
      checkResult.innerHTML = `<span class="text-green-700 font-semibold">Ingreso registrado: ${lastCheckedWorker.nombre} (${lastCheckedWorker.dni})</span>`;
      registerEntryBtn.classList.add('hidden');
      if (checkDNIInput) checkDNIInput.value = '';
      lastCheckedWorker = null;
    });
    
    // mostrar/ocultar razón social según tipo de visita
    if (visitType) visitType.addEventListener("change", () => {
      if (visitType.value === "empresa") companyWrapper.classList.remove("hidden");
      else companyWrapper.classList.add("hidden");
    });
    
    // handler para registrar visita: valida, crea un record (incluye DNI) y lo guarda para que aparezca en el reporte
    if (addVisitBtn) addVisitBtn.addEventListener("click", () => {
      const name = (visitName && visitName.value || "").trim();
      const dniVal = (visitDNI && visitDNI.value || "").trim();
      const type = (visitType && visitType.value) || "";
      const company = (visitCompany && visitCompany.value || "").trim();
      const responsible = (visitResponsible && visitResponsible.value || "").trim();
      if (!name || !type || !responsible) { alert("Complete: Apellido y Nombre, Tipo y Responsable"); return; }

      // crear registro compatible con el esquema de 'records' para que aparezca en el reporte
      const rec = {
        cuit: "",
        empresa: type === "empresa" ? company : "",
        nombre: name,
        dni: dniVal,
        tipo: type === "empresa" ? "visita_empresa" : "visita_particular",
        documents: [],
        responsableVisita: responsible,
        createdAt: new Date().toISOString()
      };
      records.push(rec);
      saveRecords(records);
      // refrescar reportes/listados
      try { renderReportTable(); } catch(e){}
      try { renderWorkersTable(); } catch(e){}

      alert("Visita registrada y agregada al reporte: " + name + (type === "empresa" ? " — Empresa: " + company : "") + " — Responsable: " + responsible);
      if (visitName) visitName.value = "";
      if (visitDNI) visitDNI.value = "";
      if (visitType) visitType.value = "";
      if (visitCompany) visitCompany.value = "";
      if (visitResponsible) visitResponsible.value = "";
      companyWrapper.classList.add("hidden");


    });  </script>
</body>
</html>